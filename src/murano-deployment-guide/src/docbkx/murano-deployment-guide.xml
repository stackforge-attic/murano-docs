<?xml version="1.0" encoding="UTF-8"?>
<!--
  Copyright (c) 2013 Mirantis, Inc.

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
   implied.
   See the License for the specific language governing permissions and
   limitations under the License.
  -->
<book xmlns="http://docbook.org/ns/docbook"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns:xlink="http://www.w3.org/1999/xlink"
      xsi:schemaLocation="http://docbook.org/ns/docbook http://www.docbook.org/xml/5.0/xsd/docbook.xsd
                          http://www.w3.org/1999/xlink http://www.w3.org/1999/xlink.xsd"
      version="5.0">
    <info>
        <title>Deployment Guide</title>
        <author>
            <personname>
                <firstname/>
                <surname/>
            </personname>
            <affiliation>
                <orgname>Mirantis, Inc.</orgname>
            </affiliation>
        </author>
        <copyright>
            <year>2013</year>
            <holder>Mirantis, Inc.</holder>
        </copyright>
        <releaseinfo>v0.1</releaseinfo>
        <productname>Murano™</productname>
        <pubdate>2013-04-04</pubdate>
        <legalnotice role="apache2">
            <annotation>
                <remark>
                    Copyright details are filled in by the template. Change the value of the role attribute on the
                    legalnotice element to change the license.
                </remark>
            </annotation>
        </legalnotice>
        <abstract>
            <para>
                This document is intended for individuals who wish to deploy and use our product or intend to
                contribute.
            </para>
        </abstract>
        <cover>
            <para>this is a placeholder for the front cover</para>
        </cover>
        <cover>
            <para>this is a placeholder for the back cover</para>
        </cover>
    </info>
    <chapter xml:id="_general_deployment_steps">
        <title>General Deployment Steps</title>
        <section xml:id="_configure_your_environment">
            <title>Configure your environment</title>
            <section xml:id="_lab_requirements">
                <title>Lab Requirements</title>
                <table xml:id="_hardware_requirements" frame="all">
                    <title>Hardware requirements</title>
                    <tgroup cols="3" align="left" rowsep="1" colsep="1">
                        <colspec colname="col1" colwidth="1*"/>
                        <colspec colname="col2" colwidth="3*"/>
                        <colspec colname="col3" colwidth="3*"/>
                        <thead>
                            <row>
                                <entry>Criteria</entry>
                                <entry>Minimal</entry>
                                <entry>Recommended</entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry>CPU</entry>
                                <entry>4 core @ 2.4 GHz</entry>
                                <entry>24 core @ 2.67 GHz</entry>
                            </row>
                            <row>
                                <entry>RAM</entry>
                                <entry>8 GB</entry>
                                <entry>24 GB or more</entry>
                            </row>
                            <row>
                                <entry>HDD</entry>
                                <entry>2 x 500 GB (7200 rpm)</entry>
                                <entry>4 x 500 GB (7200 rpm)</entry>
                            </row>
                            <row>
                                <entry>RAID</entry>
                                <entry>Software RAID-1 (use mdadm as it will improve read
                                    performance almost two times)
                                </entry>
                                <entry>Hardware RAID-10</entry>
                            </row>
                        </tbody>
                    </tgroup>
                </table>
                <table xml:id="_software_requirements" frame="all">
                    <title>Software Requirements</title>
                    <tgroup cols="1" align="left" rowsep="1" colsep="1">
                        <colspec colname="col1" colwidth="1*"/>
                        <thead>
                            <row>
                                <entry>List</entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry>Ubuntu Server 12.04 LTS</entry>
                            </row>
                        </tbody>
                    </tgroup>
                </table>
            </section>
            <section xml:id="_how_to_test_your_host_performance">
                <title>How to test your host performance</title>
                <para>We have measured time required to boot 1 to 5 instances of Windows system simultaneously. You
                    can use this data as the baseline to check if your system is fast enough.
                </para>
                <para>You should use sysprepped images for this test, to simulate VM first boot.</para>
                <para>Steps to reproduce test:</para>
                <orderedlist numeration="arabic">
                    <listitem>
                        <para>
                            Prepare Windows 2012 Standard (with GUI) image in QCOW2 format. Let's assume that its
                            name is ws-2012-std.qcow2
                        </para>
                    </listitem>
                    <listitem>
                        <para>
                            Ensure that there is NO KVM PROCESSES on the host. To do this, run command:
                            <screen>
    ps aux | grep kvm
                            </screen>
                        </para>
                    </listitem>
                    <listitem>
                        <para>
                            Make 5 copies of Windows image file:
                        </para>
                        <screen>for i in $(seq 5); do cp ws-2012-std.qcow2 ws-2012-std-$i.qcow2; done</screen>
                    </listitem>
                    <listitem>
                        <para>
                            Create script start-vm.sh in the folder with .qcow2 files:
                        </para>
                        <screen>
    #!/bin/bash
    [ -z $1 ] || echo "VM count not provided!"; exit 1
    for i in $(seq $1); do
    echo "Starting VM $i ..."
    kvm \
    -m 1024 \
    -drive file=ws-2012-std-$i.qcow2,if=virtio \
    -net user -net nic,model=virtio \
    -nographic \
    -usbdevice tablet \
    -vnc :$i &amp;
    done
                        </screen>
                    </listitem>
                    <listitem>
                        <para>
                            Start ONE instance with command below (as root) and measure time between VM&#8217;s launch
                            and the moment when Server Manager window appears. To view VM&#8217;s desktop, connect with
                            VNC viewer to your host to VNC screen :1 (port 5901):
                        </para>
                        <screen># ./start-vm.sh 1</screen>
                    </listitem>
                    <listitem>
                        <para>
                            Turn VM off. You may simply kill all KVM processes by
                        </para>
                        <screen>killall kvm</screen>
                    </listitem>
                    <listitem>
                        <para>
                            Start FIVE instances with command below (as root) and measure time interval between ALL VM&#8217;s
                            launch and the moment when LAST Server Manager window appears. To view VM&#8217;s desktops,
                            connect with VNC viewer to your host to VNC screens :1 thru :5 (ports 5901-5905):
                        </para>
                        <screen>./start-vm.sh 5</screen>
                    </listitem>
                    <listitem>
                        <para>
                            Turn VMs off. You may simply kill all KVM processes by
                        </para>
                        <screen>killall kvm</screen>
                    </listitem>
                </orderedlist>
            </section>
            <section xml:id="_baseline_data">
                <title>Baseline data</title>
                <informaltable
                        frame="all"
                        rowsep="1" colsep="1"
                        >
                    <tgroup cols="3">
                        <colspec colname="col_1" colwidth="33*"/>
                        <colspec colname="col_2" colwidth="33*"/>
                        <colspec colname="col_3" colwidth="33*"/>
                        <tbody>
                            <row>
                                <entry align="left" valign="top">
                                    <para> </para>
                                </entry>
                                <entry align="left" valign="top">
                                    <para>Boot ONE instance</para>
                                </entry>
                                <entry align="left" valign="top">
                                    <para>Boot FIVE instances</para>
                                </entry>
                            </row>
                            <row>
                                <entry align="left" valign="top">
                                    <para>Avg. Time</para>
                                </entry>
                                <entry align="left" valign="top">
                                    <para>3m:40s</para>
                                </entry>
                                <entry align="left" valign="top">
                                    <para>8m</para>
                                </entry>
                            </row>
                            <row>
                                <entry align="left" valign="top">
                                    <para>Max. Time</para>
                                </entry>
                                <entry align="left" valign="top">
                                    <para>5m</para>
                                </entry>
                                <entry align="left" valign="top">
                                    <para>20m</para>
                                </entry>
                            </row>
                        </tbody>
                    </tgroup>
                </informaltable>
            </section>
            <section xml:id="_host_optimizations">
                <title>Host optimizations</title>
                <para>The following optimizations may improve host performance up to 30%:</para>
                <itemizedlist>
                    <listitem>
                        <para>
                            change default scheduler from
                            <emphasis role="strong">CFQ</emphasis>
                            to
                            <emphasis role="strong">Deadline</emphasis>
                        </para>
                    </listitem>
                    <listitem>
                        <para>
                            use
                            <emphasis role="strong">ksm</emphasis>
                        </para>
                    </listitem>
                    <listitem>
                        <para>
                            use
                            <emphasis role="strong">vhost-net</emphasis>
                        </para>
                    </listitem>
                </itemizedlist>
            </section>
        </section>
        <section xml:id="_install_software">
            <title>Install software</title>
            <para>Currently we use Devstack (<link xlink:href="http://devstack.org/">http://devstack.org/</link>) to
                build our lab environment.
            </para>
            <para>Use Devstack&#8217;s guide to install single VM OpenStack (<link
                    xlink:href="http://devstack.org/guides/single-vm.html">
                http://devstack.org/guides/single-vm.html</link>)
            </para>
            <formalpara>
                <title>localrc example</title>
                <para>
                    <screen>
    HOST_IP=
    FLAT_INTERFACE=
    FLOATING_RANGE=

    ADMIN_PASSWORD=swordfish
    MYSQL_PASSWORD=swordfish
    RABBIT_PASSWORD=swordfish
    SERVICE_PASSWORD=swordfish
    SERVICE_TOKEN=tokentoken

    ENABLED_SERVICES+=,heat,h-api,h-api-cfn,h-api-cw,h-eng

    # Image's cache is in $TOP_DIR/files
    IMAGE_URLS+=",http://fedorapeople.org/groups/heat/prebuilt-jeos-images/F17-x86_64-cfntools.qcow2"

    # /etc/nova/nova.conf
    EXTRA_OPTS=(force_config_drive=true libvirt_images_type=qcow2 force_raw_images=false)

    # Logging
    SCREEN_LOGDIR=/opt/stack/log/
    LOGFILE=$SCREEN_LOGDIR/stack.sh.log
                    </screen>
                </para>
            </formalpara>
            <para>If you need to image builder only, then install only packages required to run
                <emphasis role="strong">KVM</emphasis>
                (see below).
            </para>
        </section>
        <section xml:id="_configure_openstack_installation">
            <title>Configure OpenStack installation</title>
            <para>If you are using Devstack, then it&#8217;s have been done.</para>
            <para>Otherwise, configure your OpenStack installation.</para>
        </section>
        <section xml:id="_install_murano_components">
            <title>Install Murano components</title>
            <para> </para>
        </section>
    </chapter>
    <chapter xml:id="_environment">
        <title>Environment</title>
        <section xml:id="_hypervisor_platform">
            <title>Hypervisor platform</title>
            <para>We use KVM and Devstack.</para>
        </section>
        <section xml:id="_install_packages">
            <title>Install Packages</title>
            <table
                    frame="all"
                    rowsep="1" colsep="1"
                    >
                <title>Software installed</title>
                <tgroup cols="2">
                    <colspec colname="col_1" colwidth="50*"/>
                    <colspec colname="col_2" colwidth="50*"/>
                    <tbody>
                        <row>
                            <entry align="left" valign="top">
                                <para>Package name</para>
                            </entry>
                            <entry align="left" valign="top">
                                <para>Package version</para>
                            </entry>
                        </row>
                        <row>
                            <entry align="left" valign="top">
                                <para>ipxe-qemu</para>
                            </entry>
                            <entry align="left" valign="top">
                                <para>1.0.0+git-4.d6b0b76-0ubuntu2</para>
                            </entry>
                        </row>
                        <row>
                            <entry align="left" valign="top">
                                <para>kvm-ipxe</para>
                            </entry>
                            <entry align="left" valign="top">
                                <para>1.0.0+git-4.d6b0b76-0ubuntu2</para>
                            </entry>
                        </row>
                        <row>
                            <entry align="left" valign="top">
                                <para>qemu-kvm</para>
                            </entry>
                            <entry align="left" valign="top">
                                <para>1.4.0+dfsg-1expubuntu4</para>
                            </entry>
                        </row>
                        <row>
                            <entry align="left" valign="top">
                                <para>munin-libvirt-plugins</para>
                            </entry>
                            <entry align="left" valign="top">
                                <para>0.0.6-1</para>
                            </entry>
                        </row>
                        <row>
                            <entry align="left" valign="top">
                                <para>python-libvirt</para>
                            </entry>
                            <entry align="left" valign="top">
                                <para>1.0.2-0ubuntu11</para>
                            </entry>
                        </row>
                        <row>
                            <entry align="left" valign="top">
                                <para>libvirt-bin</para>
                            </entry>
                            <entry align="left" valign="top">
                                <para>1.0.2-0ubuntu11</para>
                            </entry>
                        </row>
                        <row>
                            <entry align="left" valign="top">
                                <para>libvirt0</para>
                            </entry>
                            <entry align="left" valign="top">
                                <para>1.0.2-0ubuntu11</para>
                            </entry>
                        </row>
                        <row>
                            <entry align="left" valign="top">
                                <para>munin-libvirt-plugins</para>
                            </entry>
                            <entry align="left" valign="top">
                                <para>0.0.6-1</para>
                            </entry>
                        </row>
                        <row>
                            <entry align="left" valign="top">
                                <para>python-libvirt</para>
                            </entry>
                            <entry align="left" valign="top">
                                <para>1.0.2-0ubuntu11</para>
                            </entry>
                        </row>
                        <row>
                            <entry align="left" valign="top">
                                <para>virt-goodies</para>
                            </entry>
                            <entry align="left" valign="top">
                                <para>0.4-2</para>
                            </entry>
                        </row>
                        <row>
                            <entry align="left" valign="top">
                                <para>virt-manager</para>
                            </entry>
                            <entry align="left" valign="top">
                                <para>0.9.4-2ubuntu3</para>
                            </entry>
                        </row>
                        <row>
                            <entry align="left" valign="top">
                                <para>virt-top</para>
                            </entry>
                            <entry align="left" valign="top">
                                <para>1.0.7-1</para>
                            </entry>
                        </row>
                        <row>
                            <entry align="left" valign="top">
                                <para>virt-what</para>
                            </entry>
                            <entry align="left" valign="top">
                                <para>1.12-1</para>
                            </entry>
                        </row>
                        <row>
                            <entry align="left" valign="top">
                                <para>virtinst</para>
                            </entry>
                            <entry align="left" valign="top">
                                <para>0.600.3-3ubuntu1</para>
                            </entry>
                        </row>
                        <row>
                            <entry align="left" valign="top">
                                <para>python</para>
                            </entry>
                            <entry align="left" valign="top">
                                <para>2.7.4-0ubuntu1</para>
                            </entry>
                        </row>
                    </tbody>
                </tgroup>
            </table>
        </section>
        <section xml:id="_additional_software">
            <title>Additional Software</title>
            <section xml:id="_windows_adk">
                <title>Windows ADK</title>
                <para>
                    <link xlink:href="http://www.microsoft.com/en-us/download/details.aspx?id=30652">
                        http://www.microsoft.com/en-us/download/details.aspx?id=30652
                    </link>
                    Windows Assessment and Deployment Kit (ADK) for Windows® 8
                </para>
            </section>
            <section xml:id="_x11_server_for_windows">
                <title>X11 server for Windows</title>
                <para>
                    <link xlink:href="http://sourceforge.net/projects/xming/">http://sourceforge.net/projects/xming/
                    </link>
                </para>
                <para>Could be used any X11 software.
                    During work process I used XMing free X11 server
                </para>
            </section>
            <section xml:id="_config_xlaunch">
                <title>config.xlaunch</title>
                <screen>&lt;?xml version="1.0"?&gt;
                    &lt;XLaunch xmlns="http://www.straightrunning.com/XmingNotes"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://www.straightrunning.com/XmingNotes XLaunch.xsd" WindowMode="MultiWindow"
                    ClientMode="NoClient" Display="0" Clipboard="true" NoAccessControl="true"/&gt;</screen>
            </section>
            <section xml:id="_putty">
                <title>Putty</title>
                <para>We use Putty v.0.62.</para>
                <para>You can download it from
                    <link xlink:href="http://www.chiark.greenend.org.uk/~sgtatham/putty/download.html">
                        http://www.chiark.greenend.org.uk/~sgtatham/putty/download.html
                    </link>
                </para>
            </section>
            <section xml:id="_windows_server_2012_iso_image">
                <title>Windows Server 2012 ISO image</title>
                <para>We use the following Windows installation images:</para>
                <informaltable
                        frame="all"
                        rowsep="1" colsep="1"
                        >
                    <tgroup cols="2">
                        <colspec colname="col_1" colwidth="50*"/>
                        <colspec colname="col_2" colwidth="50*"/>
                        <tbody>
                            <row>
                                <entry align="left" valign="top">
                                    <para>Windows Version</para>
                                </entry>
                                <entry align="left" valign="top">
                                    <para>Image Name</para>
                                </entry>
                            </row>
                            <row>
                                <entry align="left" valign="top">
                                    <para>Windows Server 2008 R2</para>
                                </entry>
                                <entry align="left" valign="top">
                                    <para>7601.17514.101119-1850_x64fre_server_eval_en-us-GRMSXEVAL_EN_DVD.iso
                                    </para>
                                </entry>
                            </row>
                            <row>
                                <entry align="left" valign="top">
                                    <para>Windows Server 2012</para>
                                </entry>
                                <entry align="left" valign="top">
                                    <para>
                                        9200.16384.WIN8_RTM.120725-1247_X64FRE_SERVER_EVAL_EN-US-HRM_SSS_X64FREE_EN-US_DV5.iso
                                    </para>
                                </entry>
                            </row>
                        </tbody>
                    </tgroup>
                </informaltable>
                <para>You may download them using one of the following links:</para>
                <informaltable
                        frame="all"
                        rowsep="1" colsep="1"
                        >
                    <tgroup cols="2">
                        <colspec colname="col_1" colwidth="50*"/>
                        <colspec colname="col_2" colwidth="50*"/>
                        <tbody>
                            <row>
                                <entry align="left" valign="top">
                                    <para>Windows Version</para>
                                </entry>
                                <entry align="left" valign="top">
                                    <para>Download Link</para>
                                </entry>
                            </row>
                            <row>
                                <entry align="left" valign="top">
                                    <para>Windows Server 2008 R2</para>
                                </entry>
                                <entry align="left" valign="top">
                                    <para>
                                        <link xlink:href="http://www.microsoft.com/en-us/download/details.aspx?id=11093">
                                            http://www.microsoft.com/en-us/download/details.aspx?id=11093
                                        </link>
                                    </para>
                                </entry>
                            </row>
                            <row>
                                <entry align="left" valign="top">
                                    <para>Windows Server 2012</para>
                                </entry>
                                <entry align="left" valign="top">
                                    <para>
                                        <link xlink:href="http://technet.microsoft.com/en-US/evalcenter/hh670538.aspx?ocid=&amp;wt.mc_id=TEC_108_1_33">
                                            http://technet.microsoft.com/en-US/evalcenter/hh670538.aspx?ocid=&amp;wt.mc_id=TEC_108_1_33
                                        </link>
                                    </para>
                                </entry>
                            </row>
                        </tbody>
                    </tgroup>
                </informaltable>
            </section>
            <section xml:id="_virtio_red_hat_drivers_iso_image">
                <title>VirtIO Red Hat drivers ISO image</title>
                <para>Download drivers from
                    <link xlink:href="http://alt.fedoraproject.org/pub/alt/virtio-win/stable/">
                        http://alt.fedoraproject.org/pub/alt/virtio-win/stable/
                    </link>
                </para>
                <para>Please, choose stable version instead of latest, We&#8217;ve got errors with unstable drivers
                    during guest unattended install.
                </para>
            </section>
            <section xml:id="_create_floppy_drive_image">
                <title>Create floppy drive image</title>
                <para>Run commands as root</para>
                <orderedlist numeration="arabic">
                    <listitem>
                        <para>
                            Create emtpy floppy image in your home folder
                        </para>
                        <screen>dd bs=512 count=2880 if=/dev/zero of=~/floppy.img
                            mkfs.msdos ~/floppy.img
                        </screen>
                    </listitem>
                    <listitem>
                        <para>
                            Mount the image to
                            <emphasis role="strong">/media/floppy</emphasis>
                        </para>
                        <screen>mkdir /media/floppy
                            mount -o loop ~/floppy.img /media/floppy
                        </screen>
                    </listitem>
                    <listitem>
                        <para>
                            Download
                            <emphasis role="strong">autounattend.xml</emphasis>
                            file from
                            <link xlink:href="https://raw.github.com/stackforge/murano-deployment/master/image-builder/share/files/ws-2012-std/autounattend.xml">
                                https://raw.github.com/stackforge/murano-deployment/master/image-builder/share/files/ws-2012-std/autounattend.xml
                            </link>
                        </para>
                        <screen>cd ~
                            wget
                            https://raw.github.com/stackforge/murano-deployment/master/image-builder/share/files/ws-2012-std/autounattend.xml
                        </screen>
                    </listitem>
                    <listitem>
                        <para>
                            Copy our
                            <emphasis role="strong">autounattend.xml</emphasis>
                            to
                            <emphasis role="strong">/media/floppy</emphasis>
                        </para>
                        <screen>cp ~/autounattend.xml /media/floppy</screen>
                    </listitem>
                    <listitem>
                        <para>
                            Unmount the image
                        </para>
                    </listitem>
                </orderedlist>
                <screen>umount /media/floppy</screen>
            </section>
        </section>
    </chapter>
    <chapter xml:id="_build_system_preparation">
        <title>Build System Preparation</title>
        <section xml:id="_prepare_host_system">
            <title>Prepare Host System</title>
            <note>
                <para>Please check that hardware virtualization supported and enabled in BIOS.</para>
            </note>
        </section>
        <section xml:id="_install_hypervisor_and_tools">
            <title>Install Hypervisor and tools</title>
            <itemizedlist>
                <listitem>
                    <para>
                        Install packages
                    </para>
                </listitem>
            </itemizedlist>
            <screen>apt-get install ipxe-qemu kvm-ipxe qemu-kvm virt-goodies virtinst virt-manager libvirt0 libvirt-bin
                munin-libvirt-plugins python python-libvirt python-libxml2 python-minimal python-pycurl python-pyorbit
                python-requests python-six samba samba-common openssh-server virt-top virt-what
            </screen>
            <itemizedlist>
                <listitem>
                    <para>
                        Create shared resource on the system
                    </para>
                </listitem>
            </itemizedlist>
            <formalpara>
                <title>Configure samba based share</title>
                <para>
                    <screen>mkdir -p /opt/samba/share
                        chown -R nobody:nogroup /opt/samba/share
                    </screen>
                </para>
            </formalpara>
            <itemizedlist>
                <listitem>
                    <para>
                        Edit the /etc/samba/smb.conf
                    </para>
                    <orderedlist numeration="arabic">
                        <listitem>
                            <para>
                                /etc/samba/smb.conf
                            </para>
                        </listitem>
                    </orderedlist>
                </listitem>
            </itemizedlist>
            <screen>
    ...
    [global]
    server string = %h server (Samba, Ubuntu)
    map to guest = Bad User
    obey pam restrictions = Yes
    pam password change = Yes
    passwd program = /usr/bin/passwd %u
    passwd chat = *Enter\snew\s*\spassword:* %n\n *Retype\snew\s*\spassword:* %n\n
    *password\supdated\ssuccessfully* .
    unix password sync = Yes
    syslog = 0
    log file = /var/log/samba/log.%m
    max log size = 1000
    dns proxy = No
    usershare allow guests = Yes
    panic action = /usr/share/samba/panic-action %d
    idmap config * : backend = tdb
    ...
    [share]
    comment = Deployment Share
    path = /opt/samba/share
    read only = No
    create mask = 0755
    guest ok = Yes
    ...
            </screen>
        </section>
        <section xml:id="_upload_installation_images_to_shared_resource">
            <title>Upload installation images to shared resource</title>
            <para> </para>
        </section>
        <section xml:id="_add_display_env_variable_on_host_system">
            <title>Add DISPLAY env variable on HOST system</title>
            <para>If you do not use/have UI on HOST, add to
                <emphasis role="strong">/etc/profile</emphasis>
                for whole system or to  
                <emphasis role="strong">
                    <literal>~/.bashrc</literal>
                </emphasis>
                or  
                <emphasis role="strong">
                    <literal>~/.profile</literal>
                </emphasis>
                for your own session:
            </para>
            <screen>export DISPLAY=IP_OF_YOUR_PC_WITH_X11_SERVER:0</screen>
            <formalpara>
                <title>What you should get after relogin</title>
                <para>
                    <screen>root@ubuntu: env | grep DISPLAY
                        DISPLAY=IP_OF_YOUR_PC_WITH_X11_SERVER:0
                    </screen>
                </para>
            </formalpara>
        </section>
    </chapter>
    <chapter xml:id="_manual_build">
        <title>Manual Build</title>
        <warning>
            <para>Please note that the preferred way to build images is to use
                <emphasis role="strong">Automated Build</emphasis>
                described later in this book.
            </para>
        </warning>
        <section xml:id="_get_windows_post_install_script">
            <title>Get Windows Post Install script</title>
            <para>All post-install actions are performed by script named<emphasis role="strong">wpi.ps1</emphasis>.
                You may download it using the link
                <link xlink:href="https://raw.github.com/stackforge/murano-deployment/master/image-builder/share/scripts/ws-2012-std/wpi.ps1">
                    https://raw.github.com/stackforge/murano-deployment/master/image-builder/share/scripts/ws-2012-std/wpi.ps1
                </link>
            </para>
            <para>To finish image preparation
                <emphasis role="strong">Start-Sysprep.ps1</emphasis>
                script is used. You may download it using the link
                <link xlink:href="https://raw.github.com/stackforge/murano-deployment/master/image-builder/share/scripts/ws-2012-std/Start-Sysprep.ps1">
                    https://raw.github.com/stackforge/murano-deployment/master/image-builder/share/scripts/ws-2012-std/Start-Sysprep.ps1
                </link>
            </para>
            <note>
                <para>There are a few scripts named<emphasis role="strong">wpi.ps1</emphasis>, each supports only one
                    version of Windows image. The script above is intended to be used to create Windows Server 2012
                    Standard. To build other version of Windows please use appropriate script from
                    <emphasis role="strong">scripts</emphasis>
                    folder.
                </para>
            </note>
        </section>
        <section xml:id="_copy_scripts_to_the_shared_folder">
            <title>Copy scripts to the shared folder</title>
            <para>All scripts should be copied to the shared resource folder, subfolder<emphasis role="strong">
                Scripts</emphasis>.
            </para>
        </section>
        <section xml:id="_create_guest_vm">
            <title>Create guest VM</title>
            <section xml:id="_way_1_from_console">
                <title>Way 1 - from console</title>
                <para>Run all commands as root.</para>
                <formalpara>
                    <title>Preallocate disk image</title>
                    <para>
                        <screen>qemu-img create -f qcow2 -o preallocation=metadata
                            /var/lib/libvirt/images/winserv_vio.qcow2 20G
                        </screen>
                    </para>
                </formalpara>
                <formalpara>
                    <title>Start guest install</title>
                    <para>
                        <screen>
    virt-install --connect qemu:///system --hvm --name WinServ --ram 2048 --vcpus 2 \
    --cdrom
    /opt/samba/share/9200.16384.WIN8_RTM.120725-1247_X64FRE_SERVER_EVAL_EN-US-HRM_SSS_X64FREE_EN-US_DV5.ISO
    \
    --disk path=/opt/samba/share/virtio-win-0.1-52.iso,device=cdrom \
    --disk path=/opt/samba/share/flop.img,device=floppy \
    --disk path=/var/lib/libvirt/images/winserv_vio.qcow2,format=qcow2,bus=virtio,cache=none \
    --network network=default,model=virtio \
    --memballoon model=virtio --vnc --os-type=windows --os-variant=win2k8 --noautoconsole \
--accelerate --noapic --keymap=en-us --video=cirrus --force
                        </screen>
                    </para>
                </formalpara>
            </section>
            <section xml:id="_way_2_from_virt_manager_ui">
                <title>Way 2 - from virt-manager UI</title>
                <itemizedlist>
                    <listitem>
                        <para>
                            launch virt-manager from shell as root
                        </para>
                    </listitem>
                    <listitem>
                        <para>
                            set Guest VM name and Local install media
                        </para>
                    </listitem>
                    <listitem>
                        <para>
                            add 1 cdrom - Windows Server ISO image
                        </para>
                    </listitem>
                    <listitem>
                        <para>
                            set OS type: Windows and version: Windows Server 2008
                        </para>
                    </listitem>
                    <listitem>
                        <para>
                            set CPU and RAM amount
                        </para>
                    </listitem>
                    <listitem>
                        <para>
                            deselect Enable storage for this virtual machine
                        </para>
                    </listitem>
                    <listitem>
                        <para>
                            select Customize configuration before install
                        </para>
                    </listitem>
                    <listitem>
                        <para>
                            add 2 cdrom - virtio ISO image
                        </para>
                    </listitem>
                    <listitem>
                        <para>
                            add floppy - our floppy image
                        </para>
                    </listitem>
                    <listitem>
                        <para>
                            add/or create HDD image with Disk bus: VirtIO and storage format: QCOW2
                        </para>
                    </listitem>
                    <listitem>
                        <para>
                            set network device model: VirtIO
                        </para>
                    </listitem>
                    <listitem>
                        <para>
                            If everything OK - start installation process, guest vm screen accessible through Console
                            button
                        </para>
                    </listitem>
                </itemizedlist>
            </section>
        </section>
        <section xml:id="_finish_process">
            <title>Finish process</title>
            <para>After install process finished for reference image compression run as root</para>
            <screen>qemu-img convert -O qcow2 /var/lib/libvirt/images/winserv_vio.qcow2
                /var/lib/libvirt/images/winserv_vio_ref.qcow2
            </screen>
        </section>
    </chapter>
    <chapter xml:id="_automated_build">
        <title>Automated Build</title>
        <orderedlist numeration="arabic">
            <listitem>
                <para>
                    Clone
                    <emphasis role="strong">murano-deployment</emphasis>
                    repository
                </para>
                <screen>git clone git://github.com/stackforge/murano-deployment.git</screen>
            </listitem>
            <listitem>
                <para>
                    Change directory to
                    <emphasis role="strong">murano-deployment/image-builder</emphasis>
                    folder.
                </para>
            </listitem>
            <listitem>
                <para>
                    Create folder structure for image builder
                </para>
                <screen>make build-root</screen>
            </listitem>
            <listitem>
                <para>
                    Create shared resource
                </para>
                <formalpara>
                    <title>Add to /etc/samba/smb.conf</title>
                    <para>
                        <screen>
    [image-builder-share]
    comment = Image Builder Share
    browsable = yes
    path = /opt/image-builder/share
    guest ok = yes
    guest user = nobody
    read only = no
    create mask = 0755
                        </screen>
                    </para>
                </formalpara>
                <formalpara>
                    <title>Restart samba services</title>
                    <para>
                        <screen>restart smbd &amp;&amp; restart nmbd</screen>
                    </para>
                </formalpara>
            </listitem>
            <listitem>
                <para>
                    Test that all required files are in place
                </para>
                <screen>make test-build-files</screen>
            </listitem>
            <listitem>
                <para>
                    Get list of available images
                </para>
                <screen>make</screen>
            </listitem>
            <listitem>
                <para>
                    Run image build process
                </para>
                <screen>make ws-2012-std</screen>
            </listitem>
            <listitem>
                <para>
                    Wait until process finishes
                </para>
            </listitem>
            <listitem>
                <para>
                    The image file
                    <emphasis role="strong">ws-2012-std.qcow2</emphasis>
                    should be stored under
                    <emphasis role="strong">/opt/image-builder/share/images</emphasis>
                    folder.
                </para>
            </listitem>
        </orderedlist>
    </chapter>
    <chapter xml:id="_post_building_setup">
        <title>Image registration</title>
        <para>
            Murano is one of the Openstack services which communicates with other Openstack components. Therefore just
            created image should be registered in Openstack Glance - image operation service.
        </para>
        <orderedlist>
            <listitem>
                <para>
                    Use the glance image-create command to import your disk image to Glance:
                    <screen>
    $ glance image-create --name "NAME" --is-public IS_PUBLIC --disk-format DISK_FORMAT
    --container-format CONTAINER_FORMAT --file IMAGE --property IMAGE_METADATA

                    </screen>
                </para>
                <para>
                    Replace the command line arguments to glance image-create with the
                    appropriate values for your environment and disk image:
                </para>
                <itemizedlist>
                    <listitem>
                        <para>Replace NAME with the name that users will refer to the disk image by.</para>
                    </listitem>
                    <listitem>
                        <para>Replace IS_PUBLIC with true or false. Setting this value to true means that all users will
                            be able
                            to view and use the image.
                        </para>
                    </listitem>
                    <listitem>
                        <para>Replace DISK_FORMAT with the format of the virtual machine disk
                            image. Valid values include raw, vhd, vmdk, vdi, iso, qcow2, aki, and ami.
                        </para>
                    </listitem>
                    <listitem>
                        <para>
                            Replace CONTAINER_FORMAT with the container format of the image. The container format is
                            bare unless the image is packaged in a file format such as ovf or ami that includes
                            additional metadata related to the image.
                        </para>
                    </listitem>
                    <listitem>
                        <para>
                            Replace IMAGE with the local path to the image file to upload.
                        </para>
                    </listitem>
                    <listitem>
                        <para>
                            Replace IMAGE_METADATA with the following property:
                            <emphasis>murano_image_info="{'title': 'Windows 2012 Core edition', 'id': NAME }"</emphasis>,
                            where <emphasis>title </emphasis>- full image description for user and
                            <emphasis>id</emphasis> is one of an image service names: ws-2012-std, ws-2012-core, ws-2008r2-std, ws-2008r2
                            <warning>
                                <para>Setting <emphasis>murano_image_info</emphasis>  property is
                                    required to pick up image from Murano Dashboard.</para>
                            </warning>
                        </para>
                    </listitem>
                </itemizedlist>
            </listitem>
            <listitem>
                <para>To update image metadata perform this command:</para>
                <screen>
    $ glance image-update IMAGE-ID --property IMAGE_MATADATA
                </screen>
                <itemizedlist>
                    <listitem>
                        <para>Replace IMAGE-ID with image id from the previous command output.</para>
                    </listitem>
                    <listitem>
                        <para>
                            Replace IMAGE_METADATA with murano_image_info property, e.g.<emphasis>
                            murano_image_info='{"title": "Windows 2012 Core edition","id": "ws-2012-std"}'</emphasis>,
                        </para>
                    </listitem>
                </itemizedlist>
            </listitem>
        </orderedlist>
        <para>After these steps desired image can be chosen in Murano dashboard and used for services platform.</para>
    </chapter>
</book>
