<?xml version="1.0" encoding="UTF-8"?>
<!--
 Copyright (c) 2013 Mirantis, Inc.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
 implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->
<chapter xmlns="http://docbook.org/ns/docbook"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns:xlink="http://www.w3.org/1999/xlink"
      xsi:schemaLocation="http://docbook.org/ns/docbook http://www.docbook.org/xml/5.0/xsd/docbook.xsd
                          http://www.w3.org/1999/xlink http://www.w3.org/1999/xlink.xsd"
      version="5.0">
    <title>Murano dashboard plugin</title>
    <para>
        To use Murano you should be familiar with Openstack. Murano Dashboard is just a plugin to Openstack dashboard - Horizon.
        Please visit
        <link xlink:href="http://docs.openstack.org/user-guide/content/"> horizon user guide </link>
        first to see how dashboard is organized and how to login to it.
    </para>
    <section>
        <title>Creating environment</title>
        <para> Once you installed all Murano components and login to horizon dashboard successfully you will see Environments panel:</para>
        <mediaobject>
            <imageobject role="fo">
                <imagedata  fileref="../images/env_panel.png" scalefit="1" width="100%" contentdepth="100%"/>
            </imageobject>
        </mediaobject>
        <para>
            First thing you need to do is to create an environment - virtual Windows Data Center which will contain different Windows services.
            Navigate to the "Environments" page and click the "Create Environment". After setting name to your virtual environment it will be created.
            Just created environment has status <emphasis>Ready to configure</emphasis>.
        </para>
        <mediaobject>
            <imageobject role="fo">
                <imagedata fileref="../images/env_btn.png" scalefit="1" width="100%" contentdepth="100%"/>
            </imageobject>
        </mediaobject>
    </section>
    <section>
        <title>Creating service prototype</title>
        <para >
            All services should be created in the context of Environment
            - virtual Windows Data Center. After Environment is created services prototypes
            and then deploy the Environment. When deploy process is done instances
            with your service will be spawned in Openstack.
            To create service prototype navigate to environment services by
            clicking on the environment name (or on the "Services" button) and click
            the "Create Service" button.
        </para>
            <mediaobject>
                <imageobject role="fo">
                    <imagedata fileref="../images/service_btn.png" scalefit="1" width="100%" contentdepth="100%"/>
                </imageobject>
            </mediaobject>
        <para>
            You have opportunity to create one of the following services:
        </para>
        <mediaobject>
            <imageobject role="fo">
                <imagedata fileref="../images/service_list.png" scalefit="1" width="100%" contentdepth="50%" />
            </imageobject>
        </mediaobject>
        <para>
            Once you choose service that you want to create click "Next" and fill the form.
            Forms for each service are specific.
            To see more information about filling the form for a specified service follow one of the link below:
        </para>
        <itemizedlist>
            <listitem>
                <para>
                    <emphasis role="bold"><link linkend="AD">Active Directory:</link></emphasis>
                    Active Directory is a directory service implemented by Microsoft for Windows domain networks.
                    In one installation in addition to primary Domain Controller
                    you can add optional count of secondary Domain Controllers.
                    Any other services you are intending to create can be
                    joined to that domain.
            </para>
            </listitem>
            <listitem>
                <para>
                    <emphasis role="bold">
                        <link linkend="IIS">Internet Information Service:</link></emphasis>
                    IIS is a web server and a set of feature extension modules.
                </para>
            </listitem>
            <listitem>
                <para>
                    <emphasis role="bold">
                        <link linkend="IISfarm">Internet Information Web Farm Service:</link>
                    </emphasis>
                    Murano installs the Web Farm Framework on the controller server,
                    configures the primary server and prepares the secondary servers.
                    In addition load balancer is installed to monitor service statuses.
                </para>
            </listitem>
            <listitem>
                <para>
                    <emphasis role="bold">
                        <link linkend="ASP">ASP.NET Service:</link>
                    </emphasis>
                    is a server-side Web application framework designed for Web
                    development to produce dynamic Web pages. Service is able
                    to install custom application onto one IIS Web Server. Murano installs
                    all needed components and make proper configuration.
            </para>
            </listitem>
            <listitem>
                <para>
                    <emphasis role="bold">
                        <link linkend="ASPfarm">ASP.NET Farm Service:</link>
                    </emphasis>
                    ASP.NET Farm Service installs a custom application on a
                    load-balanced array of IIS servers
                </para>
            </listitem>
            <listitem>
                <para>
                    <emphasis role="bold"><link linkend="SQL">MS SQL Service:</link></emphasis>
                    Microsoft SQL Service is a relational database management system.
                </para>
            </listitem>
            <listitem>
                <para>
                    <emphasis role="bold">
                        <link linkend="SQLfarm">SQL Server Failover Cluster:</link>
                    </emphasis>
                    Murano installs all needed components and configures your
                    SQL Server Cluster the way you want.
                </para>
            </listitem>
        </itemizedlist>
        <para>
            On the last step of creating service prototype you have opportunity to set
            the hardware flavor of the instance which will be created -
            and the image with the operating system, which will be installed on
            the instance. Also you may select availability zone, if there are more
            then one in your environment.
        </para>
        <mediaobject>
            <imageobject role="fo">
                <imagedata fileref="../images/last_step.png" scalefit="1" width="100%" contentdepth="100%"/>
            </imageobject>
        </mediaobject>
        <section  xml:id="AD">
            <title>Active Directory</title>
            <mediaobject>
                <imageobject role="fo">
                    <imagedata fileref="../images/ad.png" scalefit="1" width="100%" contentdepth="100%"/>
                </imageobject>
            </mediaobject>
        </section>
        <section xml:id="IIS">
            <title>Internet Information Service</title>
            <mediaobject>
                <imageobject role="fo">
                    <imagedata fileref="../images/iis.png" scalefit="1" width="100%" contentdepth="100%"/>
                </imageobject>
            </mediaobject>
        </section>
        <section xml:id="IISfarm">
            <title>Internet Information Web Farm Service</title>
            <mediaobject>
                <imageobject role="fo">
                    <imagedata fileref="../images/iis_farm.png" scalefit="1" width="100%" contentdepth="100%"/>
                </imageobject>
            </mediaobject>
        </section>
        <section xml:id="ASP">
            <title>ASP.NET Service</title>
            <mediaobject>
                <imageobject role="fo">
                    <imagedata fileref="../images/asp_net.png" scalefit="1" width="100%" contentdepth="100%"/>
                </imageobject>
            </mediaobject>
        </section>
        <section xml:id="ASPfarm">
            <title>ASP.NET Farm Service</title>
            <mediaobject>
                <imageobject role="fo">
                    <imagedata fileref="../images/asp_net_farm.png" scalefit="1" width="100%" contentdepth="100%"/>
                </imageobject>
            </mediaobject>
        </section>
        <section xml:id="SQL">
            <title>MS SQL Service</title>
            <mediaobject>
                <imageobject role="fo">
                    <imagedata fileref="../images/sql.png" scalefit="1" width="100%" contentdepth="100%"/>
                </imageobject>
            </mediaobject>
        </section>
        <section xml:id="SQLfarm">
            <title>SQL Server Failover Cluster</title>
            <mediaobject>
                <imageobject role="fo">
                    <imagedata fileref="../images/cluster1.png" scalefit="1" width="100%" contentdepth="100%"/>
                </imageobject>
            </mediaobject>
            <mediaobject>
                <imageobject role="fo">
                    <imagedata fileref="../images/cluster1a.png" scalefit="1" width="100%" contentdepth="100%"/>
                </imageobject>
            </mediaobject>
            <mediaobject>
                <imageobject role="fo">
                    <imagedata fileref="../images/cluster2.png" scalefit="1" width="100%" contentdepth="100%"/>
                </imageobject>
            </mediaobject>
        </section>
    </section>
    <section>
        <title>Deploying environment</title>
        <para>
            Once all services are prepared you can send environment to deploy.
            Just press the "Deploy Environment" button.
        </para>
        <mediaobject>
                <imageobject role="fo">
                    <imagedata fileref="../images/deploy_btn.png" scalefit="1" width="100%" contentdepth="100%"/>
                </imageobject>
        </mediaobject>
        <para>
            And you'll see a message about successful start of deploying your services in Openstack. Since now all you have to do is just wait for a little bit
            while Murano installing and configuring your services.
        </para>
        <mediaobject>
            <imageobject role="fo">
                <imagedata fileref="../images/deploy_started.png" scalefit="1"
                           width="100%" contentdepth="100%"/>
            </imageobject>
        </mediaobject>
        <para>
            You can monitor deploying process. Just go to the Log tab on service
            detailed page where you can get by clicking on the service name.
        </para>
        <mediaobject>
            <imageobject role="fo">
                <imagedata fileref="../images/service_name.png" scalefit="1" width="100%" contentdepth="100%"/>
            </imageobject>
        </mediaobject>
        <para>
            And now you can see installation progress.
        </para>
        <mediaobject>
            <imageobject role="fo">
                <imagedata fileref="../images/logs.png" scalefit="1" width="100%" contentdepth="100%"/>
            </imageobject>
        </mediaobject>
        <para>
            As long as installation and configuration are in progress environment
            is in <emphasis>Deploying</emphasis> state. Depending on how many
            services you are deploying or how many nodes in your cluster, process of spawning instances,
            installation and post installation settings takes from 10 minutes up to one hour.
        </para>
        <mediaobject>
            <imageobject role="fo">
                <imagedata fileref="../images/env_deploy.png" scalefit="1" width="100%" contentdepth="100%"/>
            </imageobject>
        </mediaobject>
        <para>
            If installation process finished without any errors environment changes its status to
            <emphasis>Ready:</emphasis>
        </para>
        <mediaobject>
            <imageobject role="fo">
                <imagedata fileref="../images/done.png" scalefit="1" width="100%" contentdepth="100%"/>
            </imageobject>
        </mediaobject>
    </section>
    <section>
        <title>Working with deployed environment</title>
        <para>
            Congratulations! After some time waiting you are able to operate with the services.
            To get information about installed services navigate to service detailed page.
            To do that click on the environment name and then on the name of the service you what to know about.
        </para>
        <mediaobject>
            <imageobject role="fo">
                <imagedata fileref="../images/iis_farm_detail.png" scalefit="1" width="100%" contentdepth="100%"/>
            </imageobject>
        </mediaobject>
        <para>
            Now you are seeing general information about the service in terms of Murano Environment.
            To get information about the instance in Openstack terms follow the link on service instance name.
        </para>
        <mediaobject>
            <imageobject role="fo">
                <imagedata fileref="../images/name_link.png" scalefit="1"/>
            </imageobject>
        </mediaobject>
        <para>
            You can login to the virtual machine directly from the horizon (if your Openstack installation allows you) or by RDP protocol.
        </para>
        <mediaobject>
            <imageobject role="fo">
                <imagedata fileref="../images/instance_console.png" scalefit="1"
                           width="100%" contentdepth="100%"/>
            </imageobject>
        </mediaobject>
        <para>There are more things you can do with Murano Environment:</para>
        <itemizedlist>
            <listitem>
                <para><link linkend="redeploy">Add new services and deploy it again;</link></para>
            </listitem>
            <listitem>
                <para><link linkend="delete">Delete outdated and unnecessary environments or services;</link></para>
            </listitem>
            <listitem>
                <para><link linkend="deployments">Browse deployment history and service installation logs;</link></para>
            </listitem>
            <listitem>
                <para><link linkend="edit">Rename your environment.</link></para>
            </listitem>
        </itemizedlist>
        <section xml:id="redeploy">
            <title>Redeploying Murano Environment</title>
            <para>
                Murano gives opportunity to supplement already deployed environment.
                If you deployed the Active Directory service and want to create
                any other service just create desired service prototype and click on the "Deploy Environment" button.
                During service prototype creation you can join this service to the existent Active Directory domain.
            </para>
        </section>
        <section xml:id="delete">
            <title>Deleting</title>
            <para>Services as well as environments can be easily deleted.</para>
            <itemizedlist>
                <listitem>
                    <para>To delete an environment go to the environment index page and click "More" -> "Delete Environment" in Actions column of ready to delete environment.</para>
                    <mediaobject>
                        <imageobject role="fo">
                            <imagedata fileref="../images/env_delete.png"
                                       scalefit="1" width="100%"
                                       contentdepth="100%"/>
                        </imageobject>
                    </mediaobject>
                    <para>
                        Environment deletion means to kill all services with instances on which they are installed.
                        Instances will be scheduled to delete right after you choose the "Delete Environment" action.
                    </para>
                </listitem>
                <listitem>
                    <para>
                        To delete a service go service list page and click the "Delete Service" button in Actions column. <emphasis role="bold">Note:</emphasis>
                        If you are deleting service that was already deployed you'll need to <emphasis>Deploy</emphasis> the environment again by pressing corresponding button.
                        In case you want to delete service prototype - it has <emphasis>"Service draft created"</emphasis> in the <emphasis>
                        Last operation</emphasis> column (see the screenshot below) - changes applies right away.
                    </para>
                    <mediaobject>
                        <imageobject role="fo">
                            <imagedata fileref="../images/service_delete.png"
                                       scalefit="1" width="100%"
                                       contentdepth="100%"/>
                        </imageobject>
                    </mediaobject>
                </listitem>
            </itemizedlist>
        </section>
        <section xml:id="deployments">
            <title>Browsing Murano Deployment</title>
            <para>
                Since Murano Environment can be deployed many times you may want
                to see the history of its deployments. To do that click the "More-> Show deployments"
                button on environments index page:
            </para>
            <mediaobject>
                <imageobject role="fo">
                    <imagedata fileref="../images/env_show.png" scalefit="1" width="100%" contentdepth="100%"/>
                </imageobject>
            </mediaobject>
            <para>
                From this page it's easy to see how many times and when Murano Environment was deployed:
            </para>
            <mediaobject>
                <imageobject role="fo">
                    <imagedata fileref="../images/deployments.png" scalefit="1" width="100%" contentdepth="100%"/>
                </imageobject>
            </mediaobject>
            <para>
                For each deployment you can get a detailed information by clicking the "Show Details" button.
                You always can go back to any level using navigation string at the page header.
                From here you can observe what services were installed during deployment:
            </para>
            <mediaobject>
                <imageobject role="fo">
                    <imagedata fileref="../images/deployment_configuration.png"
                               scalefit="1" width="100%" contentdepth="100%"/>
                </imageobject>
            </mediaobject>
            <para>Also deployment logs are available at the "Logs" tab:</para>
            <mediaobject>
                <imageobject role="fo">
                    <imagedata
                            fileref="../images/deployment_logs.png"
                            scalefit="1" width="100%" contentdepth="100%"/>
                </imageobject>
            </mediaobject>
        </section>
        <section xml:id="edit">
            <title>Renaming Murano Environment</title>
            <para>
                It's possible to change name of your environment: just click the "More-> Edit Environment" button on environment index page:
            </para>
            <mediaobject>
                <imageobject role="fo">
                    <imagedata fileref="../images/env_edit.png" scalefit="1" width="100%" contentdepth="100%"/>
                </imageobject>
            </mediaobject>
            <para>
                Environment name is not involved in service creation process so you can use spaces and any other
                characters you want.
            </para>
            <mediaobject>
                <imageobject role="fo">
                    <imagedata fileref="../images/env_edit2.png" scalefit="1"
                               width="100%" contentdepth="100%"/>
                </imageobject>
            </mediaobject>
        </section>
    </section>
    <section xml:id="trouble">
        <title>Troubleshooting</title>
            <para><emphasis role="bold"> How to debug OpenStack Heat?</emphasis></para>
            <para>

                If you can execute Heat command via console interface - all good. It is
                the most simple way to check Heat state on the node - jest execute CLI
                command 'heat list'.

                See more information about Heat in openstack wiki
                <link xlink:href="https://wiki.openstack.org/wiki/Heat/TroubleShooting"> page</link>
            </para>
            <para><emphasis role="bold"> If 'heat list' returns 503 error</emphasis></para>
            <para>
                It is means that OpenStack Heat configuration files contains incorrect
                credentials. Need to set 'user' = 'heat' and change passwords
                'verybadpass' in all configuration files from directory /etc/heat/
            </para>
            <para><emphasis role="bold">If 'heat list' hangs up</emphasis></para>
            <para>
                Sometimes ypu can see that 'heat list' hangs up. The root of this
                problem - connection to the rabbitMQ.
            </para>
            <para><emphasis role="bold">How I can connect to LoadBalancer instance in Server Farms?</emphasis></para>
            <para>
                First of all you should have KeyPair file 'murano-lb-key', you can
                create this file using commands
                <programlisting>
                    <![CDATA[
nova keypair-add murano-lb-key > murano-lb-key.priv
chmod 600 murano-lb-key.priv
                    ]]>
                </programlisting>
                And after that you should create server farms with this KeyPair.
                The second step is to 'how to connect to VM with LoadBalancer':
                <programlisting>
                <![CDATA[
ssh -i murano-lb-key.priv root@10.0.0.3
                ]]>
              </programlisting>
            </para>
            <para><emphasis role="bold">Murano dashboard can not connect to Murano API. How I can fix it?</emphasis></para>
            <para>
                This is problem has two ways to fix:
                Add string
                    <programlisting>
                        <![CDATA[
MURANO_API_URL='http://localhost:8082'
                                ]]>
                    </programlisting>

                to file /etc/openstack-dashboard/local_settings (or
                /etc/openstack-dashboard/local_settings.py - it is depends on OpenStack
                configuration)
                and after that need to restart web server.
                Add keystone endpoints for Murano API
                    <programlisting>
                        <![CDATA[
keystone service-create --name muranoapi --type murano --description "Murano-Api Service"
keystone endpoint-create --region RegionOne --service-id
--publicurl http://localhost:8082 --internalurl http://localhost:8082 --adminurl http://localhost:8082
                    ]]>
                </programlisting>
            </para>
            <para><emphasis role="bold">
                Murano API Service does not work on CentOS 6.x. WebUI can not connect
                to this service. How to fix this?</emphasis>
                </para>
            <para>
                The problem in pip lib routes. Need to upgrade this lib and restart
                Murano API:
                <programlisting>
                    <![CDATA[
python-pip install routes --upgrade
initctl stop murano-api
initctl start murano-api
                ]]>
            </programlisting>
            </para>
            <para><emphasis role="bold">
                Error 'Unexpected state' during the deployment of Web Farms. What the
                problem? </emphasis>
            </para>
            <para>
                Sometimes we can see in logs of the deployments:
                <programlisting>
                    <![CDATA[
2013-08-06 09:10:07 - Unable to deploy instance ipkrmhk0vzq4b6 (asp-farm_instance_0) due to Unexpected state
2013-08-06 09:10:07 - Unable to create a Server Farm load balancer on unit ipkrmhk0vzq4b6 (asp-farm_instance_0) due to Unexpected state
                                ]]>
                </programlisting>
                The root of this problem in incorrect configuration - Heat can not
                create Load Balancer instance. Please, remember that you should have
                admin access for project in OpenStack to deploy LoadBalancer and also,
                you should have KeyPair with default name 'murano-lb-key'.
            </para>
            <para><emphasis role="bold">Error in Murano API logs 'No module named helpers.token_sanitizer'</emphasis></para>
             <para>
                This is problem with pip version. Need to install pip 1.4 and after that reinstall murano-client, murano-common and murano-api.
            </para>
    </section>
</chapter>